"""
Vulnerability Explanations Database

This module provides detailed, educational explanations for each
suspicious API or pattern detected by the Zero-Trust Launcher.
"""

VULNERABILITY_EXPLANATIONS = {
    # === CRITICAL SEVERITY ===
    "WriteProcessMemory": {
        "severity": "CRITICAL",
        "description": "Allows writing data directly into another process's memory space.",
        "why_dangerous": "This is the primary technique used for process injection attacks. Malware uses this to inject malicious code into legitimate processes (e.g., explorer.exe, svchost.exe) to evade detection.",
        "legitimate_uses": "Debuggers, game trainers, some anti-cheat systems",
        "malware_examples": "Remote Access Trojans (RATs), ransomware loaders, rootkits"
    },
    
    "CreateRemoteThread": {
        "severity": "CRITICAL",
        "description": "Creates a thread that runs in the virtual address space of another process.",
        "why_dangerous": "Combined with WriteProcessMemory, this allows malware to execute injected code in a remote process. This is a classic DLL injection technique.",
        "legitimate_uses": "Very rare - some debugging tools",
        "malware_examples": "Banking trojans, keyloggers, credential stealers"
    },
    
    "GetAsyncKeyState": {
        "severity": "CRITICAL",
        "description": "Determines whether a key is up or down at the time the function is called.",
        "why_dangerous": "This is the primary API used for keylogging. Malware continuously polls this function to capture every keystroke, including passwords and credit card numbers.",
        "legitimate_uses": "Games (for input detection), some accessibility tools",
        "malware_examples": "Keyloggers, spyware, information stealers"
    },
    
    # === HIGH SEVERITY ===
    "VirtualAlloc": {
        "severity": "HIGH",
        "description": "Reserves or commits a region of memory with specific protection attributes.",
        "why_dangerous": "Often used to allocate executable memory for shellcode. Malware uses PAGE_EXECUTE_READWRITE to create memory regions where it can write and execute malicious code.",
        "legitimate_uses": "JIT compilers, emulators, games with anti-cheat, memory allocators",
        "malware_examples": "Shellcode loaders, exploit kits, fileless malware"
    },
    
    "AdjustTokenPrivileges": {
        "severity": "HIGH",
        "description": "Enables or disables privileges in an access token (e.g., SeDebugPrivilege).",
        "why_dangerous": "Malware uses this to escalate privileges, allowing it to debug other processes, bypass UAC, or access protected system resources.",
        "legitimate_uses": "System utilities, backup software, anti-cheat systems",
        "malware_examples": "Privilege escalation exploits, ransomware, rootkits"
    },
    
    "exec": {
        "severity": "HIGH",
        "description": "Executes arbitrary Python code from a string.",
        "why_dangerous": "Allows dynamic code execution, making it trivial for malware to download and run additional payloads, decrypt embedded code, or execute commands received from a C2 server.",
        "legitimate_uses": "REPLs, some dynamic frameworks (rare)",
        "malware_examples": "Python-based RATs, backdoors, cryptominers"
    },
    
    "eval": {
        "severity": "HIGH",
        "description": "Evaluates a Python expression from a string and returns the result.",
        "why_dangerous": "Similar to exec, but can be used to obfuscate malicious logic. Malware uses this to decode encrypted commands or execute dynamically generated code.",
        "legitimate_uses": "Calculators, some parsers (bad practice)",
        "malware_examples": "Obfuscated malware, web shells, backdoors"
    },
    
    "subprocess": {
        "severity": "HIGH",
        "description": "Spawns new processes and executes system commands.",
        "why_dangerous": "Allows malware to execute arbitrary shell commands, download additional payloads (curl, wget), modify system settings, or launch other malicious executables.",
        "legitimate_uses": "Automation scripts, build tools, system utilities",
        "malware_examples": "Backdoors, cryptominers, ransomware (for file encryption)"
    },
    
    "os.system": {
        "severity": "HIGH",
        "description": "Executes a command in a subshell.",
        "why_dangerous": "Similar to subprocess but less controlled. Malware uses this for command execution, persistence (scheduled tasks), or lateral movement.",
        "legitimate_uses": "Legacy scripts, quick automation",
        "malware_examples": "Web shells, backdoors, worms"
    },
    
    "ctypes": {
        "severity": "HIGH",
        "description": "Provides C-compatible data types and allows calling functions in DLLs/shared libraries.",
        "why_dangerous": "In Python malware, ctypes is used to call low-level Windows APIs (VirtualAlloc, WriteProcessMemory) that aren't normally accessible in Python. This enables process injection, memory manipulation, and anti-analysis techniques.",
        "legitimate_uses": "Interfacing with C libraries, performance optimization",
        "malware_examples": "Python-based RATs, fileless malware, memory scrapers"
    },
    
    # === MEDIUM SEVERITY ===
    "CreateToolhelp32Snapshot": {
        "severity": "MEDIUM",
        "description": "Takes a snapshot of processes, heaps, modules, and threads.",
        "why_dangerous": "Malware uses this to enumerate running processes, looking for antivirus, sandboxes, or analysis tools. It can then terminate them or modify its behavior to evade detection.",
        "legitimate_uses": "Task managers, system monitors, anti-cheat systems, debuggers",
        "malware_examples": "Anti-analysis malware, process killers, sandbox evasion"
    },
    
    "WinDLL": {
        "severity": "MEDIUM",
        "description": "Python ctypes class for loading Windows DLLs.",
        "why_dangerous": "Allows Python malware to load and call functions from any Windows DLL, including kernel32.dll and ntdll.dll for low-level system manipulation.",
        "legitimate_uses": "Interfacing with Windows APIs from Python",
        "malware_examples": "Python malware using native Windows APIs"
    },
    
    "kernel32": {
        "severity": "MEDIUM",
        "description": "Reference to kernel32.dll, the core Windows API library.",
        "why_dangerous": "Contains low-level functions for memory, process, and thread management. Malware uses these for injection, hooking, and evasion.",
        "legitimate_uses": "Any low-level Windows programming",
        "malware_examples": "Most Windows malware uses kernel32 APIs"
    },
    
    "advapi32": {
        "severity": "MEDIUM",
        "description": "Reference to advapi32.dll, containing advanced Windows APIs.",
        "why_dangerous": "Provides access to registry manipulation, service control, and privilege escalation functions.",
        "legitimate_uses": "System administration tools, installers",
        "malware_examples": "Persistence mechanisms, privilege escalation"
    },
}


def get_explanation(api_or_pattern):
    """
    Get detailed explanation for a suspicious API or pattern.
    
    Args:
        api_or_pattern: The API function name or pattern (e.g., "VirtualAlloc", "exec")
    
    Returns:
        dict: Explanation with severity, description, why_dangerous, etc.
        None: If no explanation exists
    """
    return VULNERABILITY_EXPLANATIONS.get(api_or_pattern)


def format_explanation(api_or_pattern):
    """
    Format explanation as a readable string.
    
    Args:
        api_or_pattern: The API function name or pattern
    
    Returns:
        str: Formatted explanation
    """
    exp = get_explanation(api_or_pattern)
    if not exp:
        return f"No detailed explanation available for '{api_or_pattern}'"
    
    return f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” {api_or_pattern} [{exp['severity']} SEVERITY]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“– What it does:
   {exp['description']}

âš ï¸  Why it's dangerous:
   {exp['why_dangerous']}

âœ… Legitimate uses:
   {exp['legitimate_uses']}

ğŸ¦  Malware examples:
   {exp['malware_examples']}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
